<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>智能课堂 —— 微博ajax接口测试 - www.zhinengshe.com</title>
<link href="style/weibo.css" rel="stylesheet" type="text/css" />
<script src="ajax5.js"></script>
<script>
window.onload=function ()
{
	//发布
	var oTxt=document.getElementById('tijiaoText');
	var oBtn=document.getElementById('btn1');
	var oParentDiv=document.getElementById('div_list');
	var oPageDiv=document.getElementById('page_div');
	
	function createReply(id, content, time, acc, ref)
	{
		//
		var oDate=new Date();
		oDate.setTime(time*1000);
		
		var str=oDate.getFullYear()+'-'+(oDate.getMonth()+1)+'-'+oDate.getDate()+' '+oDate.getHours()+':'+oDate.getMinutes()+':'+oDate.getSeconds();
		
		//
		var oNewDiv=document.createElement('div');
		
		oNewDiv.className='reply';
		oNewDiv.innerHTML=
'<p class="replyContent">'+content+'</p>\
<p class="operation">\
	<span class="replyTime">'+str+'</span>\
	<span class="handle">\
		<a href="javascript:;" class="top">'+acc+'</a>\
		<a href="javascript:;" class="down_icon">'+ref+'</a>\
		<a href="javascript:;" class="cut">删除</a>\
	</span>\
</p>';
		
		//加上顶、踩
		var oAUp=oNewDiv.getElementsByTagName('a')[0];
		var oADown=oNewDiv.getElementsByTagName('a')[1];
		
		oAUp.onclick=function ()
		{
			ajax({
				url:	'weibo.php',
				json:	{act: 'acc', id: id},
				fnSucc:	function (str){
					var json=eval('('+str+')');
					
					if(json.error==0)
					{
						oAUp.innerHTML=parseInt(oAUp.innerHTML)+1;
					}
					else
					{
						alert('顶失败了');
					}
				}
			});
		};
		
		return oNewDiv;
	}
	
	oBtn.onclick=function ()
	{
		ajax({
			url:		'weibo.php',
			json:		{act: 'add', content: oTxt.value, t: Math.random()},
			fnSucc:		function (str){
				document.write(url);
				//{error:0, id: 新添加内容的ID, time: 添加时间}
				var json=eval('('+str+')');
				
				if(json.error==0)
				{
					var oNewDiv=createReply(json.id, oTxt.value, json.time, 0, 0);
					
					if(oParentDiv.children.length>0)
					{
						oParentDiv.insertBefore(oNewDiv, oParentDiv.children[0]);
					}
					else
					{
						oParentDiv.appendChild(oNewDiv);
					}
					
					//多出来了-删了
					if(oParentDiv.children.length>6)
					{
						oParentDiv.removeChild(oParentDiv.children[oParentDiv.children.length-1]);
					}
					
					oTxt.value='';
				}
				else
					alert('失败');
			},
			fnFaild:	function (){
				alert('发布消息失败，请稍后重试');
			}
		});
	};
	
	//获取
	getPage(1);
	
	function getPage(n)
	{
		ajax({
			url:	'weibo.php',
			json:	{act: 'get', page: n},
			fnSucc:	function (str){
				var arr=eval('('+str+')');
				
				oParentDiv.innerHTML='';
				
				for(var i=0;i<arr.length;i++)
				{
					var oNewDiv=createReply(arr[i].id, arr[i].content, arr[i].time, arr[i].acc, arr[i].ref);
					
					oParentDiv.appendChild(oNewDiv);
				}
			}
		});
	}
	
	//获取多少页
	ajax({
		url:	'weibo.php',
		json:	{act: 'get_page_count'},
		fnSucc:	function (str){
			var json=eval('('+str+')');
			
			for(var i=0;i<json.count;i++)
			{
				var oA=document.createElement('a');
				
				oA.href='javascript:;';
				oA.innerHTML=i+1;
				
				oPageDiv.appendChild(oA);
				
				oA.onclick=function ()
				{
					for(var i=0;i<oPageDiv.children.length;i++)
					{
						oPageDiv.children[i].className='';
					}
					this.className='active';
					
					getPage(this.innerHTML);
				};
			}
			
			oPageDiv.children[0].className='active';
		}
	});
};
</script>
</head>

<body>
<div class="znsArea">
<!--留言-->
     <div class="takeComment">
        <textarea name="textarea" class="takeTextField" id="tijiaoText"></textarea>
        <div class="takeSbmComment">
            <input type="button" class="inputs" value="" id="btn1" />
            <span>(可按 Enter 回复)</span>
        </div>
    </div>
<!--已留-->
    <div class="commentOn">
        <div class="noContent">暂无留言</div>
        <div class="messList" id="div_list">
        </div>
        <div class="page" id="page_div">
        	<!--<a href="javascript:;" class="active">1</a>
        	<a href="javascript:;">2</a>
        	<a href="javascript:;">3</a>-->
        </div>
    </div>
</div>
</body>
</html>
