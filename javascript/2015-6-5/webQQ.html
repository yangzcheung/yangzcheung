<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>无标题文档</title>
<script src="jsonp.js"></script>
<script>
window.onload=function ()
{
	var URL='http://www.zhinengshe.com/exercise/im/api.php';
	var token='';
	var maxID=0;

	var oDivBefore=document.getElementById('before_login');
	var oDivAfter=document.getElementById('after_login');

	//注册、登陆
	var oUser=document.getElementById('user');
	var oPass=document.getElementById('pass');
	var oFace=document.getElementById('face_sel');
	var oBtnReg=document.getElementById('btn1');
	var oBtnLogin=document.getElementById('btn2');

	//注册
	oBtnReg.onclick=function ()
	{
		//?a=reg&user=用户名&pass=密码&face=头像ID&cb=xxx
		jsonp(
			URL,
			{
				a: 'reg',
				user: oUser.value,
				pass: oPass.value,
				face: oFace.value
			},
			function (json)
			{
				if(json.err==0)
				{
					alert('注册成功，请登录');
				}
				else
				{
					alert('注册失败：'+json.msg);
				}
			}
		);
	};

	//登陆
	oBtnLogin.onclick=function ()
	{
		//?a=lgn&user=用户名&pass=密码&cb=xxx
		jsonp(
			URL,
			{
				a:	'lgn',
				user:	oUser.value,
				pass:	oPass.value
			},
			function (json)
			{
				if(json.err==0)
				{
					alert('登陆成功'+json.token);
					token=json.token;

					oDivBefore.style.display='none';
					oDivAfter.style.display='block';

					//获取消息
					getMsg();

					//获取用户列表
					getUserList();

					//开定时器
					setInterval(getNewMsg, 1000);
				}
			}
		);
	};

	//
	function getMsg()
	{
		//?a=get_msg&token=&cb=xxx
		jsonp(
			URL,
			{
				a:	'get_msg',
				token:	token
			},
			function (json)
			{
				if(json.err==0)
				{
					//alert(json.data);
					var oUl=document.getElementById('ul1');

					for(var i=0;i<json.data.length;i++)
					{
						var oLi=document.createElement('li');
						oLi.innerHTML='<h2>'+json.data[i].username+'</h2> <em>'+json.data[i].post_time+'</em><p>'+json.data[i].content+'</p>';

						oUl.appendChild(oLi);
					}
					maxID=json.data[json.data.length-1].ID;
				}
				else
				{
					alert('获取消息失败，请重新登陆');
				}
			}
		);
	}

	function getUserList()
	{
		//?a=get_user_list&token=&cb=xxx
		jsonp(
			URL,
			{
				a:	'get_user_list',
				token:	token
			},
			function (json)
			{
				if(json.err==0)
				{
					var oOl=document.getElementById('ol1');
					for(var i=0;i<json.data.length;i++)
					{
						var oLi=document.createElement('li');

						oLi.innerHTML='<img src="face/'+json.data[i].face+'.jpg" /> '+json.data[i].username;

						oOl.appendChild(oLi);
					}
				}
				else
				{
					alert('获取失败');
				}
			}
		);
	}

	function getNewMsg()
	{
		//?a=get_msg_n&n=消息ID&token=&cb=xxx
		jsonp(
			URL,
			{
				a:	'get_msg_n',
				n:	maxID,
				token:	token
			},
			function (json)
			{
				if(json.err==0)
				{
					var oUl=document.getElementById('ul1');
					for(var i=0;i<json.data.length;i++)
					{
						var oLi=document.createElement('li');

						oLi.innerHTML='<h2>'+json.data[i].username+'</h2> <em>'+json.data[i].post_time+'</em><p>'+json.data[i].content+'</p>';

						oUl.appendChild(oLi);
					}

					maxID=json.data[json.data.length-1].ID;
				}
				else
				{
					alert('获取失败');
				}
			}
		);
	}
};
</script>
<style>
* {margin: 0; padding:0; list-style: none;}

#after_login {display: none;}


#before_login {width:240px; height:150px; background: #CCC; border: 1px solid black; position: absolute; left: 50%; top: 50%; margin-left: -120px; margin-top: -75px;}
#after_login ul {width: 600px; border:1px solid black; height:400px; overflow: auto;}
#after_login ul li {padding:4px; border-bottom: 1px dashed #666;}
#after_login ul li h2 {float: left; font:14px 'microsoft yahei';}
#after_login ul li em {float: left; font-style: normal; padding-left:10px;}
#after_login ul li p {clear: left;}
#after_login ol {width:300px; height:500px; position: absolute; left: 600px; top: 0; overflow: auto;}
#after_login ol li {padding:4px; border-bottom: 1px solid #CCC;}
#after_login ol li img {width:16px; height:16px;}

</style>
</head>

<body>
<div id="before_login">
	用户：<input type="text" id="user" /><br/>
	密码：<input type="password" id="pass" /><br/>
	头像：<select id="face_sel">
		<option value="1">1号</option>
		<option value="2">2号</option>
		<option value="3">3号</option>
		<option value="4">4号</option>
		<option value="5">5号</option>
		<option value="6">6号</option>
		<option value="7">7号</option>
		<option value="8">8号</option>
	</select><br/>
	<input type="button" value="注册" id="btn1" />
	<input type="button" value="登陆" id="btn2" />
</div>
<div id="after_login">
	<ul id="ul1">
		<!--<li>
			<h2>名字</h2> <em>时间</em>
			<p>内容内容内容内容</p>
		</li>-->
	</ul>
	<div>
		<textarea id="txt1" style="width:550px; height:100px;"></textarea>
		<input type="button" value="发送" />
	</div>
	<ol id="ol1">
		<!--<li><img src="xxx" />名字</li>-->
	</ol>
</div>
</body>
</html>